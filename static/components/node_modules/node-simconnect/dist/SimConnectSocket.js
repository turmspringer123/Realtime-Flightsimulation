"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RecvID = exports.SimConnectSocket = void 0;
const net_1 = require("net");
const stream_1 = require("stream");
const RawBuffer_1 = require("./RawBuffer");
const HEADER_LENGTH = 4;
var RecvID;
(function (RecvID) {
    RecvID[RecvID["ID_NULL"] = 0] = "ID_NULL";
    RecvID[RecvID["ID_EXCEPTION"] = 1] = "ID_EXCEPTION";
    RecvID[RecvID["ID_OPEN"] = 2] = "ID_OPEN";
    RecvID[RecvID["ID_QUIT"] = 3] = "ID_QUIT";
    RecvID[RecvID["ID_EVENT"] = 4] = "ID_EVENT";
    RecvID[RecvID["ID_EVENT_OBJECT_ADDREMOVE"] = 5] = "ID_EVENT_OBJECT_ADDREMOVE";
    RecvID[RecvID["ID_EVENT_FILENAME"] = 6] = "ID_EVENT_FILENAME";
    RecvID[RecvID["ID_EVENT_FRAME"] = 7] = "ID_EVENT_FRAME";
    RecvID[RecvID["ID_SIMOBJECT_DATA"] = 8] = "ID_SIMOBJECT_DATA";
    RecvID[RecvID["ID_SIMOBJECT_DATA_BYTYPE"] = 9] = "ID_SIMOBJECT_DATA_BYTYPE";
    RecvID[RecvID["ID_WEATHER_OBSERVATION"] = 10] = "ID_WEATHER_OBSERVATION";
    RecvID[RecvID["ID_CLOUD_STATE"] = 11] = "ID_CLOUD_STATE";
    RecvID[RecvID["ID_ASSIGNED_OBJECT_ID"] = 12] = "ID_ASSIGNED_OBJECT_ID";
    RecvID[RecvID["ID_RESERVED_KEY"] = 13] = "ID_RESERVED_KEY";
    RecvID[RecvID["ID_CUSTOM_ACTION"] = 14] = "ID_CUSTOM_ACTION";
    RecvID[RecvID["ID_SYSTEM_STATE"] = 15] = "ID_SYSTEM_STATE";
    RecvID[RecvID["ID_CLIENT_DATA"] = 16] = "ID_CLIENT_DATA";
    RecvID[RecvID["ID_EVENT_WEATHER_MODE"] = 17] = "ID_EVENT_WEATHER_MODE";
    RecvID[RecvID["ID_AIRPORT_LIST"] = 18] = "ID_AIRPORT_LIST";
    RecvID[RecvID["ID_VOR_LIST"] = 19] = "ID_VOR_LIST";
    RecvID[RecvID["ID_NDB_LIST"] = 20] = "ID_NDB_LIST";
    RecvID[RecvID["ID_WAYPOINT_LIST"] = 21] = "ID_WAYPOINT_LIST";
    RecvID[RecvID["ID_EVENT_MULTIPLAYER_SERVER_STARTED"] = 22] = "ID_EVENT_MULTIPLAYER_SERVER_STARTED";
    RecvID[RecvID["ID_EVENT_MULTIPLAYER_CLIENT_STARTED"] = 23] = "ID_EVENT_MULTIPLAYER_CLIENT_STARTED";
    RecvID[RecvID["ID_EVENT_MULTIPLAYER_SESSION_ENDED"] = 24] = "ID_EVENT_MULTIPLAYER_SESSION_ENDED";
    RecvID[RecvID["ID_EVENT_RACE_END"] = 25] = "ID_EVENT_RACE_END";
    RecvID[RecvID["ID_EVENT_RACE_LAP"] = 26] = "ID_EVENT_RACE_LAP";
    // KittyHawk:
    RecvID[RecvID["ID_EVENT_EX1"] = 27] = "ID_EVENT_EX1";
    RecvID[RecvID["ID_FACILITY_DATA"] = 28] = "ID_FACILITY_DATA";
    RecvID[RecvID["ID_FACILITY_DATA_END"] = 29] = "ID_FACILITY_DATA_END";
    RecvID[RecvID["ID_FACILITY_MINIMAL_LIST"] = 30] = "ID_FACILITY_MINIMAL_LIST";
})(RecvID || (RecvID = {}));
exports.RecvID = RecvID;
/**
 * For connecting, reading and writing to the SimConnect server.
 * The emitted "data"-event contains a SimConnectMessage-object.
 * Inspired by https://www.derpturkey.com/extending-tcp-socket-in-node-js/
 */
class SimConnectSocket extends stream_1.Duplex {
    constructor() {
        super({ objectMode: true });
        this._readingPaused = false;
        this._socket = new net_1.Socket();
        this._socket.setNoDelay(false);
        this._wrapSocket();
    }
    connect(address) {
        switch (address.type) {
            case 'pipe':
                this._socket.connect(address.address);
                break;
            case 'ipv4':
                this._socket.connect(address.port, address.host);
                break;
            default:
                throw Error('Unsupported address type. Must be "ipv4" or "pipe"');
        }
    }
    close() {
        this._socket.destroy();
    }
    _wrapSocket() {
        this._socket.on('close', hadError => this.emit('close', hadError));
        this._socket.on('connect', () => this.emit('connect'));
        this._socket.on('drain', () => this.emit('drain'));
        this._socket.on('end', () => this.emit('end'));
        this._socket.on('error', err => this.emit('error', err));
        this._socket.on('lookup', (err, address, family, host) => this.emit('lookup', err, address, family, host)); // prettier-ignore
        this._socket.on('ready', () => this.emit('ready'));
        this._socket.on('timeout', () => this.emit('timeout'));
        this._socket.on('readable', this._onReadable.bind(this));
    }
    _onReadable() {
        while (!this._readingPaused) {
            // Read message length header
            const lenBuf = this._socket.read(HEADER_LENGTH);
            if (!lenBuf)
                return;
            const bodyLength = lenBuf.readInt32LE() - HEADER_LENGTH;
            // Read message body
            const body = this._socket.read(bodyLength);
            if (!body) {
                // Put header back in read buffer
                this._socket.unshift(lenBuf);
                return;
            }
            const message = {
                // Mandatory fields
                protocolVersion: body.readInt32LE(0),
                packetTypeId: body.readInt32LE(4),
                data: new RawBuffer_1.RawBuffer(body.slice(8)),
            };
            // Add object to read buffer
            const pushOk = this.push(message);
            // Pause reading if consumer is slow
            if (!pushOk)
                this._readingPaused = true;
        }
    }
    _read() {
        this._readingPaused = false;
        setImmediate(this._onReadable.bind(this));
    }
    _write(data, encoding, cb) {
        this._socket.write(data, encoding, cb);
    }
}
exports.SimConnectSocket = SimConnectSocket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2ltQ29ubmVjdFNvY2tldC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9TaW1Db25uZWN0U29ja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZCQUE2QjtBQUM3QixtQ0FBZ0M7QUFDaEMsMkNBQXdDO0FBR3hDLE1BQU0sYUFBYSxHQUFHLENBQUMsQ0FBQztBQUV4QixJQUFLLE1BaUNKO0FBakNELFdBQUssTUFBTTtJQUNQLHlDQUFPLENBQUE7SUFDUCxtREFBWSxDQUFBO0lBQ1oseUNBQU8sQ0FBQTtJQUNQLHlDQUFPLENBQUE7SUFDUCwyQ0FBUSxDQUFBO0lBQ1IsNkVBQXlCLENBQUE7SUFDekIsNkRBQWlCLENBQUE7SUFDakIsdURBQWMsQ0FBQTtJQUNkLDZEQUFpQixDQUFBO0lBQ2pCLDJFQUF3QixDQUFBO0lBQ3hCLHdFQUFzQixDQUFBO0lBQ3RCLHdEQUFjLENBQUE7SUFDZCxzRUFBcUIsQ0FBQTtJQUNyQiwwREFBZSxDQUFBO0lBQ2YsNERBQWdCLENBQUE7SUFDaEIsMERBQWUsQ0FBQTtJQUNmLHdEQUFjLENBQUE7SUFDZCxzRUFBcUIsQ0FBQTtJQUNyQiwwREFBZSxDQUFBO0lBQ2Ysa0RBQVcsQ0FBQTtJQUNYLGtEQUFXLENBQUE7SUFDWCw0REFBZ0IsQ0FBQTtJQUNoQixrR0FBbUMsQ0FBQTtJQUNuQyxrR0FBbUMsQ0FBQTtJQUNuQyxnR0FBa0MsQ0FBQTtJQUNsQyw4REFBaUIsQ0FBQTtJQUNqQiw4REFBaUIsQ0FBQTtJQUNqQixhQUFhO0lBQ2Isb0RBQVksQ0FBQTtJQUNaLDREQUFnQixDQUFBO0lBQ2hCLG9FQUFvQixDQUFBO0lBQ3BCLDRFQUF3QixDQUFBO0FBQzVCLENBQUMsRUFqQ0ksTUFBTSxLQUFOLE1BQU0sUUFpQ1Y7QUFnRzBCLHdCQUFNO0FBeEZqQzs7OztHQUlHO0FBQ0gsTUFBTSxnQkFBaUIsU0FBUSxlQUFNO0lBS2pDO1FBQ0ksS0FBSyxDQUFDLEVBQUUsVUFBVSxFQUFFLElBQUks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RSxHQUFHLGFBQWEsQ0FBQztZQUV4RCxvQkFBb0I7WUFDcEIsTUFBTSxJQUFJLEdBQVcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDbkQsSUFBSSxDQUFDLElBQUksRUFBRTtnQkFDUCxpQ0FBaUM7Z0JBQ2pDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUM3QixPQUFPO2FBQ1Y7WUFFRCxNQUFNLE9BQU8sR0FBc0I7Z0JBQy9CLG1CQUFtQjtnQkFDbkIsZUFBZSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO2dCQUNwQyxZQUFZLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pDLElBQUksRUFBRSxJQUFJLHFCQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUNyQyxDQUFDO1lBRUYsNEJBQTRCO1lBQzVCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFbEMsb0NBQW9DO1lBQ3BDLElBQUksQ0FBQyxNQUFNO2dCQUFFLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO1NBQzNDO0lBQ0wsQ0FBQztJQUVELEtBQUs7UUFDRCxJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQztRQUM1QixZQUFZLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRUQsTUFBTSxDQUFDLElBQVksRUFBRSxRQUF3QixFQUFFLEVBQWtDO1FBQzdFLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDM0MsQ0FBQztDQUNKO0FBRVEsNENBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU29ja2V0IH0gZnJvbSAnbmV0JztcbmltcG9ydCB7IER1cGxleCB9IGZyb20gJ3N0cmVhbSc7XG5pbXBvcnQgeyBSYXdCdWZmZXIgfSBmcm9tICcuL1Jhd0J1ZmZlcic7XG5pbXBvcnQgeyBDb25uZWN0aW9uUGFyYW1ldGVycyB9IGZyb20gJy4vY29ubmVjdGlvblBhcmFtZXRlcnMnO1xuXG5jb25zdCBIRUFERVJfTEVOR1RIID0gNDtcblxuZW51bSBSZWN2SUQge1xuICAgIElEX05VTEwsXG4gICAgSURfRVhDRVBUSU9OLFxuICAgIElEX09QRU4sXG4gICAgSURfUVVJVCxcbiAgICBJRF9FVkVOVCxcbiAgICBJRF9FVkVOVF9PQkpFQ1RfQUREUkVNT1ZFLFxuICAgIElEX0VWRU5UX0ZJTEVOQU1FLFxuICAgIElEX0VWRU5UX0ZSQU1FLFxuICAgIElEX1NJTU9CSkVDVF9EQVRBLFxuICAgIElEX1NJTU9CSkVDVF9EQVRBX0JZVFlQRSxcbiAgICBJRF9XRUFUSEVSX09CU0VSVkFUSU9OLFxuICAgIElEX0NMT1VEX1NUQVRFLFxuICAgIElEX0FTU0lHTkVEX09CSkVDVF9JRCxcbiAgICBJRF9SRVNFUlZFRF9LRVksXG4gICAgSURfQ1VTVE9NX0FDVElPTixcbiAgICBJRF9TWVNURU1fU1RBVEUsXG4gICAgSURfQ0xJRU5UX0RBVEEsXG4gICAgSURfRVZFTlRfV0VBVEhFUl9NT0RFLFxuICAgIElEX0FJUlBPUlRfTElTVCxcbiAgICBJRF9WT1JfTElTVCxcbiAgICBJRF9OREJfTElTVCxcbiAgICBJRF9XQVlQT0lOVF9MSVNULFxuICAgIElEX0VWRU5UX01VTFRJUExBWUVSX1NFUlZFUl9TVEFSVEVELFxuICAgIElEX0VWRU5UX01VTFRJUExBWUVSX0NMSUVOVF9TVEFSVEVELFxuICAgIElEX0VWRU5UX01VTFRJUExBWUVSX1NFU1NJT05fRU5ERUQsXG4gICAgSURfRVZFTlRfUkFDRV9FTkQsXG4gICAgSURfRVZFTlRfUkFDRV9MQVAsXG4gICAgLy8gS2l0dHlIYXdrOlxuICAgIElEX0VWRU5UX0VYMSxcbiAgICBJRF9GQUNJTElUWV9EQVRBLFxuICAgIElEX0ZBQ0lMSVRZX0RBVEFfRU5ELFxuICAgIElEX0ZBQ0lMSVRZX01JTklNQUxfTElTVCxcbn1cblxuaW50ZXJmYWNlIFNpbUNvbm5lY3RNZXNzYWdlIHtcbiAgICBwcm90b2NvbFZlcnNpb246IG51bWJlcjtcbiAgICBwYWNrZXRUeXBlSWQ6IFJlY3ZJRDtcbiAgICBkYXRhOiBSYXdCdWZmZXI7XG59XG5cbi8qKlxuICogRm9yIGNvbm5lY3RpbmcsIHJlYWRpbmcgYW5kIHdyaXRpbmcgdG8gdGhlIFNpbUNvbm5lY3Qgc2VydmVyLlxuICogVGhlIGVtaXR0ZWQgXCJkYXRhXCItZXZlbnQgY29udGFpbnMgYSBTaW1Db25uZWN0TWVzc2FnZS1vYmplY3QuXG4gKiBJbnNwaXJlZCBieSBodHRwczovL3d3dy5kZXJwdHVya2V5LmNvbS9leHRlbmRpbmctdGNwLXNvY2tldC1pbi1ub2RlLWpzL1xuICovXG5jbGFzcyBTaW1Db25uZWN0U29ja2V0IGV4dGVuZHMgRHVwbGV4IHtcbiAgICBfc29ja2V0OiBTb2NrZXQ7XG5cbiAgICBfcmVhZGluZ1BhdXNlZDtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcih7IG9iamVjdE1vZGU6IHRydWUgfSk7XG4gICAgICAgIHRoaXMuX3JlYWRpbmdQYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5fc29ja2V0ID0gbmV3IFNvY2tldCgpO1xuICAgICAgICB0aGlzLl9zb2NrZXQuc2V0Tm9EZWxheShmYWxzZSk7XG4gICAgICAgIHRoaXMuX3dyYXBTb2NrZXQoKTtcbiAgICB9XG5cbiAgICBjb25uZWN0KGFkZHJlc3M6IENvbm5lY3Rpb25QYXJhbWV0ZXJzKSB7XG4gICAgICAgIHN3aXRjaCAoYWRkcmVzcy50eXBlKSB7XG4gICAgICAgICAgICBjYXNlICdwaXBlJzpcbiAgICAgICAgICAgICAgICB0aGlzLl9zb2NrZXQuY29ubmVjdChhZGRyZXNzLmFkZHJlc3MpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnaXB2NCc6XG4gICAgICAgICAgICAgICAgdGhpcy5fc29ja2V0LmNvbm5lY3QoYWRkcmVzcy5wb3J0LCBhZGRyZXNzLmhvc3QpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignVW5zdXBwb3J0ZWQgYWRkcmVzcyB0eXBlLiBNdXN0IGJlIFwiaXB2NFwiIG9yIFwicGlwZVwiJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjbG9zZSgpIHtcbiAgICAgICAgdGhpcy5fc29ja2V0LmRlc3Ryb3koKTtcbiAgICB9XG5cbiAgICBfd3JhcFNvY2tldCgpIHtcbiAgICAgICAgdGhpcy5fc29ja2V0Lm9uKCdjbG9zZScsIGhhZEVycm9yID0+IHRoaXMuZW1pdCgnY2xvc2UnLCBoYWRFcnJvcikpO1xuICAgICAgICB0aGlzLl9zb2NrZXQub24oJ2Nvbm5lY3QnLCAoKSA9PiB0aGlzLmVtaXQoJ2Nvbm5lY3QnKSk7XG4gICAgICAgIHRoaXMuX3NvY2tldC5vbignZHJhaW4nLCAoKSA9PiB0aGlzLmVtaXQoJ2RyYWluJykpO1xuICAgICAgICB0aGlzLl9zb2NrZXQub24oJ2VuZCcsICgpID0+IHRoaXMuZW1pdCgnZW5kJykpO1xuICAgICAgICB0aGlzLl9zb2NrZXQub24oJ2Vycm9yJywgZXJyID0+IHRoaXMuZW1pdCgnZXJyb3InLCBlcnIpKTtcbiAgICAgICAgdGhpcy5fc29ja2V0Lm9uKCdsb29rdXAnLCAoZXJyLCBhZGRyZXNzLCBmYW1pbHksIGhvc3QpID0+IHRoaXMuZW1pdCgnbG9va3VwJywgZXJyLCBhZGRyZXNzLCBmYW1pbHksIGhvc3QpKTsgLy8gcHJldHRpZXItaWdub3JlXG4gICAgICAgIHRoaXMuX3NvY2tldC5vbigncmVhZHknLCAoKSA9PiB0aGlzLmVtaXQoJ3JlYWR5JykpO1xuICAgICAgICB0aGlzLl9zb2NrZXQub24oJ3RpbWVvdXQnLCAoKSA9PiB0aGlzLmVtaXQoJ3RpbWVvdXQnKSk7XG5cbiAgICAgICAgdGhpcy5fc29ja2V0Lm9uKCdyZWFkYWJsZScsIHRoaXMuX29uUmVhZGFibGUuYmluZCh0aGlzKSk7XG4gICAgfVxuXG4gICAgX29uUmVhZGFibGUoKSB7XG4gICAgICAgIHdoaWxlICghdGhpcy5fcmVhZGluZ1BhdXNlZCkge1xuICAgICAgICAgICAgLy8gUmVhZCBtZXNzYWdlIGxlbmd0aCBoZWFkZXJcbiAgICAgICAgICAgIGNvbnN0IGxlbkJ1ZiA9IHRoaXMuX3NvY2tldC5yZWFkKEhFQURFUl9MRU5HVEgpO1xuICAgICAgICAgICAgaWYgKCFsZW5CdWYpIHJldHVybjtcbiAgICAgICAgICAgIGNvbnN0IGJvZHlMZW5ndGggPSBsZW5CdWYucmVhZEludDMyTEUoKSAtIEhFQURFUl9MRU5HVEg7XG5cbiAgICAgICAgICAgIC8vIFJlYWQgbWVzc2FnZSBib2R5XG4gICAgICAgICAgICBjb25zdCBib2R5OiBCdWZmZXIgPSB0aGlzLl9zb2NrZXQucmVhZChib2R5TGVuZ3RoKTtcbiAgICAgICAgICAgIGlmICghYm9keSkge1xuICAgICAgICAgICAgICAgIC8vIFB1dCBoZWFkZXIgYmFjayBpbiByZWFkIGJ1ZmZlclxuICAgICAgICAgICAgICAgIHRoaXMuX3NvY2tldC51bnNoaWZ0KGxlbkJ1Zik7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlOiBTaW1Db25uZWN0TWVzc2FnZSA9IHtcbiAgICAgICAgICAgICAgICAvLyBNYW5kYXRvcnkgZmllbGRzXG4gICAgICAgICAgICAgICAgcHJvdG9jb2xWZXJzaW9uOiBib2R5LnJlYWRJbnQzMkxFKDApLFxuICAgICAgICAgICAgICAgIHBhY2tldFR5cGVJZDogYm9keS5yZWFkSW50MzJMRSg0KSxcbiAgICAgICAgICAgICAgICBkYXRhOiBuZXcgUmF3QnVmZmVyKGJvZHkuc2xpY2UoOCkpLFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgLy8gQWRkIG9iamVjdCB0byByZWFkIGJ1ZmZlclxuICAgICAgICAgICAgY29uc3QgcHVzaE9rID0gdGhpcy5wdXNoKG1lc3NhZ2UpO1xuXG4gICAgICAgICAgICAvLyBQYXVzZSByZWFkaW5nIGlmIGNvbnN1bWVyIGlzIHNsb3dcbiAgICAgICAgICAgIGlmICghcHVzaE9rKSB0aGlzLl9yZWFkaW5nUGF1c2VkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9yZWFkKCkge1xuICAgICAgICB0aGlzLl9yZWFkaW5nUGF1c2VkID0gZmFsc2U7XG4gICAgICAgIHNldEltbWVkaWF0ZSh0aGlzLl9vblJlYWRhYmxlLmJpbmQodGhpcykpO1xuICAgIH1cblxuICAgIF93cml0ZShkYXRhOiBCdWZmZXIsIGVuY29kaW5nOiBCdWZmZXJFbmNvZGluZywgY2I6IChlcnJvcj86IEVycm9yIHwgbnVsbCkgPT4gdm9pZCkge1xuICAgICAgICB0aGlzLl9zb2NrZXQud3JpdGUoZGF0YSwgZW5jb2RpbmcsIGNiKTtcbiAgICB9XG59XG5cbmV4cG9ydCB7IFNpbUNvbm5lY3RTb2NrZXQsIFJlY3ZJRCwgU2ltQ29ubmVjdE1lc3NhZ2UsIENvbm5lY3Rpb25QYXJhbWV0ZXJzIH07XG4iXX0=